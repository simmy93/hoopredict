import { useState, useEffect } from 'react'
import { Head, Link, router } from '@inertiajs/react'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Alert, AlertDescription } from '@/components/ui/alert'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Trophy, User, Sparkles, AlertCircle, CheckCircle2, Info, Users } from 'lucide-react'
import AuthenticatedLayout from '@/layouts/AuthenticatedLayout'

interface User {
    id: number
    name: string
}

interface Team {
    id: number
    name: string
}

interface Player {
    id: number
    name: string
    position: 'Guard' | 'Forward' | 'Center'
    price: number
    photo_url: string | null
    team: Team
}

interface FantasyTeamPlayer {
    id: number
    fantasy_team_id: number
    player_id: number
    lineup_position: number | null
    purchase_price: number
    points_earned: number
    player: Player
}

interface Championship {
    id: number
    name: string
    season: string
}

interface FantasyLeague {
    id: number
    name: string
    mode: 'budget' | 'draft'
    team_size: number
    championship: Championship
}

interface FantasyTeam {
    id: number
    team_name: string
    budget_spent: number
    budget_remaining: number
    total_points: number
    lineup_type: string | null
    user: User
}

interface PositionCounts {
    Guard: number
    Forward: number
    Center: number
}

interface Props {
    league: FantasyLeague
    userTeam: FantasyTeam
    teamPlayers: FantasyTeamPlayer[]
    positionCounts: PositionCounts
    startingLineupCounts: PositionCounts
    hasValidTeamComposition: boolean
    hasValidStartingLineup: boolean
}

type LineupType = '2-2-1' | '3-1-1' | '1-3-1' | '1-2-2' | '2-1-2'

interface LineupConfig {
    guards: number
    forwards: number
    centers: number
    label: string
}

const LINEUP_CONFIGS: Record<LineupType, LineupConfig> = {
    '2-2-1': { guards: 2, forwards: 2, centers: 1, label: '2 Guards, 2 Forwards, 1 Center' },
    '3-1-1': { guards: 3, forwards: 1, centers: 1, label: '3 Guards, 1 Forward, 1 Center' },
    '1-3-1': { guards: 1, forwards: 3, centers: 1, label: '1 Guard, 3 Forwards, 1 Center' },
    '1-2-2': { guards: 1, forwards: 2, centers: 2, label: '1 Guard, 2 Forwards, 2 Centers' },
    '2-1-2': { guards: 2, forwards: 1, centers: 2, label: '2 Guards, 1 Forward, 2 Centers' },
}

// PlayerCard component for displaying players in slots
interface PlayerCardProps {
    player: FantasyTeamPlayer
    onDragStart: (player: FantasyTeamPlayer) => void
    onDragEnd: () => void
    onRemove: () => void
    percentage: string
    isSixthMan?: boolean
}

function PlayerCard({ player, onDragStart, onDragEnd, onRemove, percentage, isSixthMan = false }: PlayerCardProps) {
    return (
        <div
            draggable
            onDragStart={() => onDragStart(player)}
            onDragEnd={onDragEnd}
            className="flex flex-col items-center gap-2 cursor-move w-full"
        >
            {player.player.photo_url ? (
                <img
                    src={player.player.photo_url}
                    alt={player.player.name}
                    className={`w-16 h-16 rounded-full object-cover object-top border-2 ${isSixthMan ? 'border-yellow-400' : 'border-gray-200'}`}
                />
            ) : (
                <div className={`w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center border-2 ${isSixthMan ? 'border-yellow-400' : 'border-gray-300'}`}>
                    <User className="h-8 w-8 text-gray-400" />
                </div>
            )}
            <div className="text-center w-full">
                <div className="font-medium text-sm truncate">{player.player.name}</div>
                <div className="text-xs text-muted-foreground truncate">{player.player.team.name}</div>
                <div className="flex items-center justify-center gap-2 mt-1">
                    <Badge className="text-xs">
                        {player.player.position}
                    </Badge>
                    {isSixthMan && (
                        <Badge className="bg-yellow-500 text-white text-xs">
                            6th Man
                        </Badge>
                    )}
                </div>
                <div className="text-xs font-bold text-blue-600 mt-1">
                    {percentage} ({player.points_earned.toFixed(1)} pts)
                </div>
            </div>
            <Button
                size="sm"
                variant="ghost"
                onClick={onRemove}
                className="mt-1 text-xs h-7"
            >
                Remove
            </Button>
        </div>
    )
}

export default function ManageNew({
    league,
    userTeam,
    teamPlayers: initialTeamPlayers,
    hasValidTeamComposition,
}: Props) {
    const [lineupType, setLineupType] = useState<LineupType | null>(
        (userTeam.lineup_type as LineupType) || null
    )
    const [starters, setStarters] = useState<(FantasyTeamPlayer | null)[]>([null, null, null, null, null])
    const [sixthMan, setSixthMan] = useState<FantasyTeamPlayer | null>(null)
    const [bench, setBench] = useState<FantasyTeamPlayer[]>(initialTeamPlayers)
    const [draggedPlayer, setDraggedPlayer] = useState<FantasyTeamPlayer | null>(null)
    const [validationErrors, setValidationErrors] = useState<string[]>([])
    const [isSaving, setIsSaving] = useState(false)

    // Calculate total points for percentages
    const totalPoints = initialTeamPlayers.reduce((sum, p) => sum + p.points_earned, 0)

    // Initialize lineup from database
    useEffect(() => {
        const startersFromDb = initialTeamPlayers
            .filter(p => p.lineup_position && p.lineup_position <= 5)
            .sort((a, b) => (a.lineup_position || 0) - (b.lineup_position || 0))

        const sixthManFromDb = initialTeamPlayers
            .find(p => p.lineup_position === 6)

        const benchFromDb = initialTeamPlayers
            .filter(p => !p.lineup_position || p.lineup_position > 6)

        if (startersFromDb.length > 0) {
            const newStarters: (FantasyTeamPlayer | null)[] = [null, null, null, null, null]
            startersFromDb.forEach((player, idx) => {
                if (idx < 5) newStarters[idx] = player
            })
            setStarters(newStarters)
        }

        setSixthMan(sixthManFromDb || null)
        setBench(benchFromDb)
    }, [initialTeamPlayers])

    // Validate lineup
    useEffect(() => {
        if (!lineupType) {
            setValidationErrors([])
            return
        }

        const config = LINEUP_CONFIGS[lineupType]
        const currentStarters = starters.filter(s => s !== null) as FantasyTeamPlayer[]

        if (currentStarters.length < 5) {
            setValidationErrors([`Need ${5 - currentStarters.length} more players in starting lineup`])
            return
        }

        const counts = {
            Guard: currentStarters.filter(p => p.player.position === 'Guard').length,
            Forward: currentStarters.filter(p => p.player.position === 'Forward').length,
            Center: currentStarters.filter(p => p.player.position === 'Center').length,
        }

        const errors = []
        if (counts.Guard !== config.guards) {
            errors.push(`Need exactly ${config.guards} Guard(s), have ${counts.Guard}`)
        }
        if (counts.Forward !== config.forwards) {
            errors.push(`Need exactly ${config.forwards} Forward(s), have ${counts.Forward}`)
        }
        if (counts.Center !== config.centers) {
            errors.push(`Need exactly ${config.centers} Center(s), have ${counts.Center}`)
        }

        setValidationErrors(errors)
    }, [starters, lineupType])

    // Handle lineup type change
    const handleLineupTypeChange = (type: string) => {
        const newType = type as LineupType
        setLineupType(newType)
        // Reset starters when changing lineup type
        setStarters([null, null, null, null, null])
        setBench(initialTeamPlayers)
    }

    // Drag handlers
    const handleDragStart = (player: FantasyTeamPlayer) => {
        setDraggedPlayer(player)
    }

    const handleDragEnd = () => {
        setDraggedPlayer(null)
    }

    const handleDropOnSlot = (slotIndex: number) => {
        if (!draggedPlayer || !lineupType) return

        const config = LINEUP_CONFIGS[lineupType]
        const slotPosition = getSlotPosition(slotIndex, config)

        // Check if player position matches slot
        if (draggedPlayer.player.position !== slotPosition) {
            return // Invalid drop
        }

        // Remove from old position
        const newStarters = [...starters]
        const oldSlotIndex = newStarters.findIndex(s => s?.id === draggedPlayer.id)
        if (oldSlotIndex !== -1) {
            newStarters[oldSlotIndex] = null
        }

        const newBench = bench.filter(p => p.id !== draggedPlayer.id)

        // Remove from sixth man if applicable
        if (sixthMan?.id === draggedPlayer.id) {
            setSixthMan(null)
        }

        // Add to new slot
        newStarters[slotIndex] = draggedPlayer

        setStarters(newStarters)
        setBench(newBench)
        setDraggedPlayer(null)
    }

    const handleDropOnBench = () => {
        if (!draggedPlayer) return

        // Remove from starters
        const newStarters = [...starters]
        const slotIndex = newStarters.findIndex(s => s?.id === draggedPlayer.id)
        if (slotIndex !== -1) {
            newStarters[slotIndex] = null
            setStarters(newStarters)
        }

        // Remove from sixth man
        if (sixthMan?.id === draggedPlayer.id) {
            setSixthMan(null)
        }

        // Add to bench if not already there
        if (!bench.find(p => p.id === draggedPlayer.id)) {
            setBench([...bench, draggedPlayer])
        }

        setDraggedPlayer(null)
    }

    const handleDropOnSixthMan = () => {
        if (!draggedPlayer) return

        // Remove from old position
        const newStarters = [...starters]
        const slotIndex = newStarters.findIndex(s => s?.id === draggedPlayer.id)
        if (slotIndex !== -1) {
            newStarters[slotIndex] = null
            setStarters(newStarters)
        }

        const newBench = bench.filter(p => p.id !== draggedPlayer.id)

        // If there's already a sixth man, send them to bench
        if (sixthMan) {
            newBench.push(sixthMan)
        }

        setSixthMan(draggedPlayer)
        setBench(newBench)
        setDraggedPlayer(null)
    }

    const handleRemoveFromSlot = (slotIndex: number) => {
        const player = starters[slotIndex]
        if (!player) return

        const newStarters = [...starters]
        newStarters[slotIndex] = null
        setStarters(newStarters)

        setBench([...bench, player])
    }

    // Get slot configuration based on lineup type - organized by position lines
    const getSlotsByPosition = (config: LineupConfig) => {
        const guards: number[] = []
        const forwards: number[] = []
        const centers: number[] = []

        let slotIndex = 0

        // Guards first
        for (let i = 0; i < config.guards; i++) {
            guards.push(slotIndex++)
        }
        // Then forwards
        for (let i = 0; i < config.forwards; i++) {
            forwards.push(slotIndex++)
        }
        // Then centers
        for (let i = 0; i < config.centers; i++) {
            centers.push(slotIndex++)
        }

        return { guards, forwards, centers }
    }

    const getSlotPosition = (slotIndex: number, config: LineupConfig): 'Guard' | 'Forward' | 'Center' => {
        if (slotIndex < config.guards) return 'Guard'
        if (slotIndex < config.guards + config.forwards) return 'Forward'
        return 'Center'
    }

    const getCourtPosition = (slotIndex: number, config: LineupConfig): { left: string; top: string } => {
        // Position players on the court based on their role
        // Guards at bottom, Forwards in middle, Centers at top

        if (slotIndex < config.guards) {
            // Guards - bottom of court
            const guardIndex = slotIndex
            if (config.guards === 1) return { left: '50%', top: '75%' }
            if (config.guards === 2) {
                return guardIndex === 0 ? { left: '20%', top: '75%' } : { left: '65%', top: '75%' }
            }
            // 3 guards
            if (guardIndex === 0) return { left: '10%', top: '75%' }
            if (guardIndex === 1) return { left: '50%', top: '80%' }
            return { left: '75%', top: '75%' }
        }

        if (slotIndex < config.guards + config.forwards) {
            // Forwards - middle of court
            const forwardIndex = slotIndex - config.guards
            if (config.forwards === 1) return { left: '50%', top: '45%' }
            if (config.forwards === 2) {
                return forwardIndex === 0 ? { left: '20%', top: '45%' } : { left: '65%', top: '45%' }
            }
            // 3 forwards
            if (forwardIndex === 0) return { left: '10%', top: '45%' }
            if (forwardIndex === 1) return { left: '50%', top: '50%' }
            return { left: '75%', top: '45%' }
        }

        // Centers - top of court
        const centerIndex = slotIndex - config.guards - config.forwards
        if (config.centers === 1) return { left: '50%', top: '15%' }
        // 2 centers
        return centerIndex === 0 ? { left: '30%', top: '15%' } : { left: '60%', top: '15%' }
    }

    const getPointPercentage = (points: number): string => {
        if (totalPoints === 0) return '0%'
        return ((points / totalPoints) * 100).toFixed(1) + '%'
    }

    // Get position color
    const getPositionColor = (position: string) => {
        switch (position) {
            case 'Guard': return 'bg-blue-500'
            case 'Forward': return 'bg-amber-500'
            case 'Center': return 'bg-red-500'
            default: return 'bg-gray-500'
        }
    }

    // Save lineup
    const handleSave = () => {
        if (validationErrors.length > 0 || !lineupType) return

        setIsSaving(true)

        const lineup = starters
            .filter(s => s !== null)
            .map(s => s!.player.id)

        router.post(`/fantasy/leagues/${league.id}/lineup`, {
            lineup,
            lineup_type: lineupType,
            sixth_man: sixthMan?.player.id || null
        }, {
            preserveScroll: true,
            onSuccess: () => {
                setIsSaving(false)
            },
            onError: () => {
                setIsSaving(false)
            }
        })
    }

    const isValidLineup = validationErrors.length === 0 && lineupType !== null && starters.every(s => s !== null)

    return (
        <AuthenticatedLayout>
            <Head title={`Manage Lineup - ${league.name}`} />

            <div className="py-12">
                <div className="max-w-7xl mx-auto sm:px-6 lg:px-8 space-y-6">
                    <div className="mb-6">
                        <Link href={`/fantasy/leagues/${league.id}`} className="text-muted-foreground hover:text-foreground">
                            ‚Üê Back to League
                        </Link>
                    </div>

                    {/* Header */}
                    <Card>
                        <CardHeader>
                            <div className="flex justify-between items-start">
                                <div>
                                    <CardTitle className="text-2xl flex items-center gap-3">
                                        <Trophy className="h-6 w-6" />
                                        Manage Lineup
                                    </CardTitle>
                                    <CardDescription className="mt-2">
                                        {userTeam.team_name} - {league.name}
                                    </CardDescription>
                                </div>
                                <Button
                                    onClick={handleSave}
                                    disabled={!isValidLineup || isSaving}
                                >
                                    {isSaving ? 'Saving...' : 'Save Lineup'}
                                </Button>
                            </div>
                        </CardHeader>
                        <CardContent>
                            {!hasValidTeamComposition && (
                                <Alert variant="destructive" className="mb-4">
                                    <AlertCircle className="h-4 w-4" />
                                    <AlertDescription>
                                        Invalid team composition. Need minimum: 3 Guards, 3 Forwards, 2 Centers
                                    </AlertDescription>
                                </Alert>
                            )}

                            {validationErrors.length > 0 && (
                                <Alert variant="destructive" className="mb-4">
                                    <AlertCircle className="h-4 w-4" />
                                    <AlertDescription>
                                        <ul className="list-disc list-inside">
                                            {validationErrors.map((error, idx) => (
                                                <li key={idx}>{error}</li>
                                            ))}
                                        </ul>
                                    </AlertDescription>
                                </Alert>
                            )}

                            {isValidLineup && (
                                <Alert className="mb-4 border-green-500 text-green-700">
                                    <CheckCircle2 className="h-4 w-4" />
                                    <AlertDescription>
                                        Valid lineup! Ready to save.
                                    </AlertDescription>
                                </Alert>
                            )}

                            <Alert>
                                <Info className="h-4 w-4" />
                                <AlertDescription>
                                    <strong>Step 1:</strong> Select your starting five formation below. <strong>Step 2:</strong> Drag players from the bench to the court positions.
                                </AlertDescription>
                            </Alert>
                        </CardContent>
                    </Card>

                    {/* Lineup Type Selector */}
                    <Card>
                        <CardHeader>
                            <CardTitle>Step 1: Select Formation</CardTitle>
                            <CardDescription>Choose your starting five combination (Guards-Forwards-Centers)</CardDescription>
                        </CardHeader>
                        <CardContent>
                            <Select value={lineupType || ''} onValueChange={handleLineupTypeChange}>
                                <SelectTrigger className="w-full max-w-md">
                                    <SelectValue placeholder="Select a formation..." />
                                </SelectTrigger>
                                <SelectContent>
                                    {Object.entries(LINEUP_CONFIGS).map(([key, config]) => (
                                        <SelectItem key={key} value={key}>
                                            <span className="font-medium">{key}</span> - {config.label}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </CardContent>
                    </Card>

                    {lineupType && (
                        <>
                            {/* Main Layout: Court + Sidebar */}
                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                                {/* Basketball Court - Half-Court View */}
                                <Card className="lg:col-span-8">
                                    <CardHeader>
                                        <CardTitle>Step 2: Set Your Starting Five</CardTitle>
                                        <CardDescription>Drag players from the sidebar to the court</CardDescription>
                                    </CardHeader>
                                    <CardContent>
                                        <div className="relative bg-gradient-to-br from-orange-900/40 via-amber-800/30 to-orange-900/40 rounded-lg p-8 border-4 border-orange-900/50 min-h-[600px]">
                                            {/* Half-court lines */}
                                            <div className="absolute inset-8 border-2 border-white/40 rounded-t-lg"></div>
                                            {/* Center circle */}
                                            <div className="absolute bottom-8 left-1/2 -translate-x-1/2 w-32 h-32 border-2 border-white/40 rounded-full"></div>
                                            {/* Three-point arc */}
                                            <div className="absolute top-8 left-1/2 -translate-x-1/2 w-48 h-48 border-2 border-white/40 rounded-b-full border-t-0"></div>
                                            {/* Free throw circle */}
                                            <div className="absolute top-32 left-1/2 -translate-x-1/2 w-24 h-24 border-2 border-white/40 rounded-full"></div>
                                            {/* Lane lines */}
                                            <div className="absolute top-8 left-1/2 -translate-x-1/2 -ml-16 w-32 h-40 border-2 border-white/40 border-t-0"></div>

                                            {/* Player positions on court */}
                                            <div className="relative z-10 h-[550px]">
                                                {/* Position players absolutely based on formation */}
                                                {[0, 1, 2, 3, 4].map((slotIndex) => {
                                                    const config = LINEUP_CONFIGS[lineupType]
                                                    const slotPosition = getSlotPosition(slotIndex, config)
                                                    const player = starters[slotIndex]

                                                    // Calculate position on court based on slot index and formation
                                                    const position = getCourtPosition(slotIndex, config)

                                                    return (
                                                        <div
                                                            key={slotIndex}
                                                            onDragOver={(e) => e.preventDefault()}
                                                            onDrop={() => handleDropOnSlot(slotIndex)}
                                                            className={`
                                                                absolute w-32 h-40 flex flex-col items-center justify-center
                                                                rounded-xl border-2 transition-all
                                                                ${player ? 'bg-gradient-to-br from-gray-900 to-gray-800 border-white/60' : 'bg-black/40 border-dashed border-white/30'}
                                                                ${draggedPlayer && draggedPlayer.player.position === slotPosition ? 'ring-4 ring-green-500/70 scale-105' : ''}
                                                            `}
                                                            style={{
                                                                left: position.left,
                                                                top: position.top,
                                                            }}
                                                        >
                                                            {player ? (
                                                                <div
                                                                    draggable
                                                                    onDragStart={() => handleDragStart(player)}
                                                                    onDragEnd={handleDragEnd}
                                                                    className="flex flex-col items-center gap-1 cursor-move w-full p-2"
                                                                >
                                                                    {/* Position badge at top */}
                                                                    <div className={`absolute -top-2 left-1/2 -translate-x-1/2 ${getPositionColor(player.player.position)} text-white px-2 py-0.5 rounded text-xs font-bold`}>
                                                                        {player.player.position}
                                                                    </div>

                                                                    {player.player.photo_url ? (
                                                                        <img
                                                                            src={player.player.photo_url}
                                                                            alt={player.player.name}
                                                                            className="w-14 h-14 rounded-full object-cover object-top border-2 border-white/80"
                                                                        />
                                                                    ) : (
                                                                        <div className="w-14 h-14 rounded-full bg-gray-700 flex items-center justify-center border-2 border-white/80">
                                                                            <User className="h-7 w-7 text-gray-300" />
                                                                        </div>
                                                                    )}
                                                                    <div className="text-center w-full">
                                                                        <div className="font-bold text-white text-xs truncate">{player.player.name}</div>
                                                                        <div className="text-[10px] text-gray-300 truncate">{player.player.team.name}</div>
                                                                        <div className="text-xs font-bold text-blue-400 mt-0.5">
                                                                            {getPointPercentage(player.points_earned)}
                                                                        </div>
                                                                        <div className="text-[10px] text-gray-400">
                                                                            {player.points_earned.toFixed(1)} pts
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ) : (
                                                                <div className="text-center text-white/50 text-xs p-2">
                                                                    <Users className="h-8 w-8 mx-auto mb-1 opacity-50" />
                                                                    <span className="font-medium">{slotPosition}</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    </CardContent>
                                </Card>

                                {/* Remove old Guards/Forwards/Centers sections below */}
                                {false && LINEUP_CONFIGS[lineupType].guards > 0 && (
                                                    <div className="relative">
                                                        <div className="flex items-center gap-2 mb-3">
                                                            <div className="bg-blue-500 text-white px-3 py-1 rounded-md font-bold text-sm">
                                                                GUARDS
                                                            </div>
                                                            <div className="flex-1 h-0.5 bg-blue-300/50"></div>
                                                        </div>
                                                        <div className="flex justify-center">
                                                            <div className="grid grid-cols-3 gap-4 max-w-3xl">
                                                                {getSlotsByPosition(LINEUP_CONFIGS[lineupType]).guards.map((slotIndex) => {
                                                                    const player = starters[slotIndex]
                                                                    return (
                                                                        <div
                                                                            key={slotIndex}
                                                                            onDragOver={(e) => e.preventDefault()}
                                                                            onDrop={() => handleDropOnSlot(slotIndex)}
                                                                            className={`
                                                                                relative flex flex-col items-center p-4 rounded-lg border-2 border-dashed
                                                                                min-h-[180px] transition-all
                                                                                ${player ? 'bg-white border-green-500' : 'bg-white/50 border-blue-300'}
                                                                                ${draggedPlayer && draggedPlayer.player.position === 'Guard' ? 'ring-4 ring-green-500/50' : ''}
                                                                            `}
                                                                        >
                                                                            {player ? (
                                                                                <PlayerCard
                                                                                    player={player}
                                                                                    onDragStart={handleDragStart}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    onRemove={() => handleRemoveFromSlot(slotIndex)}
                                                                                    percentage={getPointPercentage(player.points_earned)}
                                                                                />
                                                                            ) : (
                                                                                <div className="text-center text-muted-foreground text-sm h-full flex flex-col items-center justify-center">
                                                                                    <Users className="h-8 w-8 mb-2 opacity-50" />
                                                                                    <span>Drag Guard here</span>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    )
                                                                })}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Forwards Line */}
                                                {LINEUP_CONFIGS[lineupType].forwards > 0 && (
                                                    <div className="relative">
                                                        <div className="flex items-center gap-2 mb-3">
                                                            <div className="bg-amber-500 text-white px-3 py-1 rounded-md font-bold text-sm">
                                                                FORWARDS
                                                            </div>
                                                            <div className="flex-1 h-0.5 bg-amber-300/50"></div>
                                                        </div>
                                                        <div className="flex justify-center">
                                                            <div className="grid grid-cols-3 gap-4 max-w-3xl">
                                                                {getSlotsByPosition(LINEUP_CONFIGS[lineupType]).forwards.map((slotIndex) => {
                                                                    const player = starters[slotIndex]
                                                                    return (
                                                                        <div
                                                                            key={slotIndex}
                                                                            onDragOver={(e) => e.preventDefault()}
                                                                            onDrop={() => handleDropOnSlot(slotIndex)}
                                                                            className={`
                                                                                relative flex flex-col items-center p-4 rounded-lg border-2 border-dashed
                                                                                min-h-[180px] transition-all
                                                                                ${player ? 'bg-white border-green-500' : 'bg-white/50 border-amber-300'}
                                                                                ${draggedPlayer && draggedPlayer.player.position === 'Forward' ? 'ring-4 ring-green-500/50' : ''}
                                                                            `}
                                                                        >
                                                                            {player ? (
                                                                                <PlayerCard
                                                                                    player={player}
                                                                                    onDragStart={handleDragStart}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    onRemove={() => handleRemoveFromSlot(slotIndex)}
                                                                                    percentage={getPointPercentage(player.points_earned)}
                                                                                />
                                                                            ) : (
                                                                                <div className="text-center text-muted-foreground text-sm h-full flex flex-col items-center justify-center">
                                                                                    <Users className="h-8 w-8 mb-2 opacity-50" />
                                                                                    <span>Drag Forward here</span>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    )
                                                                })}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}

                                                {/* Centers Line */}
                                                {LINEUP_CONFIGS[lineupType].centers > 0 && (
                                                    <div className="relative">
                                                        <div className="flex items-center gap-2 mb-3">
                                                            <div className="bg-red-500 text-white px-3 py-1 rounded-md font-bold text-sm">
                                                                CENTERS
                                                            </div>
                                                            <div className="flex-1 h-0.5 bg-red-300/50"></div>
                                                        </div>
                                                        <div className="flex justify-center">
                                                            <div className="grid grid-cols-3 gap-4 max-w-3xl">
                                                                {getSlotsByPosition(LINEUP_CONFIGS[lineupType]).centers.map((slotIndex) => {
                                                                    const player = starters[slotIndex]
                                                                    return (
                                                                        <div
                                                                            key={slotIndex}
                                                                            onDragOver={(e) => e.preventDefault()}
                                                                            onDrop={() => handleDropOnSlot(slotIndex)}
                                                                            className={`
                                                                                relative flex flex-col items-center p-4 rounded-lg border-2 border-dashed
                                                                                min-h-[180px] transition-all
                                                                                ${player ? 'bg-white border-green-500' : 'bg-white/50 border-red-300'}
                                                                                ${draggedPlayer && draggedPlayer.player.position === 'Center' ? 'ring-4 ring-green-500/50' : ''}
                                                                            `}
                                                                        >
                                                                            {player ? (
                                                                                <PlayerCard
                                                                                    player={player}
                                                                                    onDragStart={handleDragStart}
                                                                                    onDragEnd={handleDragEnd}
                                                                                    onRemove={() => handleRemoveFromSlot(slotIndex)}
                                                                                    percentage={getPointPercentage(player.points_earned)}
                                                                                />
                                                                            ) : (
                                                                                <div className="text-center text-muted-foreground text-sm h-full flex flex-col items-center justify-center">
                                                                                    <Users className="h-8 w-8 mb-2 opacity-50" />
                                                                                    <span>Drag Center here</span>
                                                                                </div>
                                                                            )}
                                                                        </div>
                                                                    )
                                                                })}
                                                            </div>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </CardContent>
                                </Card>

                                {/* Sidebar: Sixth Man + Available Players */}
                                <div className="lg:col-span-4 space-y-6">
                                    {/* Sixth Man Slot */}
                                    <Card>
                                        <CardHeader>
                                            <CardTitle className="text-lg flex items-center gap-2">
                                                <Sparkles className="h-5 w-5 text-yellow-500" />
                                                Sixth Man
                                            </CardTitle>
                                            <CardDescription>Key substitute player</CardDescription>
                                        </CardHeader>
                                        <CardContent>
                                            <div
                                                onDragOver={(e) => e.preventDefault()}
                                                onDrop={handleDropOnSixthMan}
                                                className={`
                                                    relative flex flex-col items-center p-4 rounded-lg border-2 border-dashed
                                                    min-h-[140px] transition-all
                                                    ${sixthMan ? 'bg-gradient-to-br from-yellow-50 to-amber-50 border-yellow-400' : 'bg-white/50 border-gray-300'}
                                                    ${draggedPlayer ? 'ring-4 ring-yellow-500/30' : ''}
                                                `}
                                            >
                                                {sixthMan ? (
                                                    <PlayerCard
                                                        player={sixthMan}
                                                        onDragStart={handleDragStart}
                                                        onDragEnd={handleDragEnd}
                                                        onRemove={() => {
                                                            setBench([...bench, sixthMan])
                                                            setSixthMan(null)
                                                        }}
                                                        percentage={getPointPercentage(sixthMan.points_earned)}
                                                        isSixthMan={true}
                                                    />
                                                ) : (
                                                    <div className="text-center text-muted-foreground text-sm h-full flex flex-col items-center justify-center">
                                                        <Sparkles className="h-8 w-8 mb-2 opacity-50" />
                                                        <span>Drag player here</span>
                                                    </div>
                                                )}
                                            </div>
                                        </CardContent>
                                    </Card>

                                    {/* Available Players */}
                                    <Card>
                                        <CardHeader>
                                            <CardTitle className="text-lg">Available Players</CardTitle>
                                            <CardDescription>Drag to lineup or sixth man</CardDescription>
                                        </CardHeader>
                                        <CardContent>
                                            <div
                                                onDragOver={(e) => e.preventDefault()}
                                                onDrop={handleDropOnBench}
                                                className="space-y-3 max-h-[600px] overflow-y-auto"
                                            >
                                                {bench.length === 0 ? (
                                                    <div className="text-center text-muted-foreground text-sm py-8">
                                                        All players assigned
                                                    </div>
                                                ) : (
                                                    bench.map((teamPlayer) => (
                                                        <div
                                                            key={teamPlayer.id}
                                                            draggable
                                                            onDragStart={() => handleDragStart(teamPlayer)}
                                                            onDragEnd={handleDragEnd}
                                                            className="flex items-center gap-3 p-3 border rounded-lg cursor-move hover:bg-muted/50 transition-all bg-white"
                                                        >
                                                            {teamPlayer.player.photo_url ? (
                                                                <img
                                                                    src={teamPlayer.player.photo_url}
                                                                    alt={teamPlayer.player.name}
                                                                    className="w-12 h-12 rounded-full object-cover object-top flex-shrink-0"
                                                                />
                                                            ) : (
                                                                <div className="w-12 h-12 rounded-full bg-muted flex items-center justify-center flex-shrink-0">
                                                                    <User className="h-6 w-6 text-muted-foreground" />
                                                                </div>
                                                            )}
                                                            <div className="flex-1 min-w-0">
                                                                <div className="font-medium text-sm truncate">{teamPlayer.player.name}</div>
                                                                <div className="text-xs text-muted-foreground truncate">{teamPlayer.player.team.name}</div>
                                                                <Badge className={`${getPositionColor(teamPlayer.player.position)} text-white text-xs mt-1`}>
                                                                    {teamPlayer.player.position}
                                                                </Badge>
                                                            </div>
                                                            <div className="text-right flex-shrink-0">
                                                                <div className="text-xs font-bold text-muted-foreground">
                                                                    {getPointPercentage(teamPlayer.points_earned)}
                                                                </div>
                                                                <div className="text-xs text-muted-foreground">
                                                                    {teamPlayer.points_earned.toFixed(1)} pts
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))
                                                )}
                                            </div>
                                        </CardContent>
                                    </Card>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            </div>
        </AuthenticatedLayout>
    )
}
